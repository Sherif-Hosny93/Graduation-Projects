<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Graduation Projects CSV Viewer</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <h1>Graduation Projects</h1>
  <div id="charts-row">
    <div class="chart-group">
      <label for="year-select">Graduation Year:</label>
      <select id="year-select"><option value="">All</option></select>
      <div class="chart-container">
        <canvas id="yearPie" width="200" height="200"></canvas>
      </div>
    </div>
    <div class="chart-group">
      <label for="university-select">University:</label>
      <select id="university-select"><option value="">All</option></select>
      <div class="chart-container">
        <canvas id="universityPie" width="200" height="200"></canvas>
      </div>
    </div>
    <div class="chart-group">
      <label for="sponsorship-select">Company Sponsorship:</label>
      <select id="sponsorship-select">
        <option value="">All</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>
      <div class="chart-container">
        <canvas id="sponsorshipPie" width="200" height="200"></canvas>
      </div>
    </div>
    <div class="chart-group">
      <label for="prof-select">Dr/Prof Name:</label>
      <select id="prof-select"><option value="">All</option></select>
      <div class="chart-container">
        <canvas id="profPie" width="200" height="200"></canvas>
      </div>
    </div>
  </div>
  <div id="table-container">Loading...</div>

  <script>
    window.addEventListener("DOMContentLoaded", function () {
      const csvURL =
        "https://raw.githubusercontent.com/Sherif-Hosny93/Graduation-Projects/main/Graduation_Projects.csv";
      let allData = [];
      let filteredData = [];
      let charts = {};
      let firstColumnName = ""; // To be detected dynamically

      function countByField(data, field) {
        const counts = {};
        data.forEach((row) => {
          const key = row[field] || "Unknown";
          counts[key] = (counts[key] || 0) + 1;
        });
        return counts;
      }

      function countByMultipleFields(data, fields) {
        const counts = {};
        data.forEach((row) => {
          fields.forEach((field) => {
            const key = row[field] && row[field].trim() !== "" ? row[field].trim() : "Unknown";
            counts[key] = (counts[key] || 0) + 1;
          });
        });
        return counts;
      }

      function populateDropdown(data, field, selectId) {
        const select = document.getElementById(selectId);
        const values = Array.from(new Set(data.map((row) => row[field] || "Unknown"))).sort();
        select.innerHTML =
          "<option value=''>All</option>" +
          values.map((val) => `<option value="${val}">${val}</option>`).join("");
      }

      function populateDropdownMultipleFields(data, fields, selectId) {
        const select = document.getElementById(selectId);
        const valuesSet = new Set();
        data.forEach((row) => {
          fields.forEach((field) => {
            const val = row[field] && row[field].trim() !== "" ? row[field].trim() : "Unknown";
            valuesSet.add(val);
          });
        });
        const values = Array.from(valuesSet).sort();
        select.innerHTML =
          "<option value=''>All</option>" +
          values.map((val) => `<option value="${val}">${val}</option>`).join("");
      }

      function renderPieChart(data, fieldOrFields, chartId, isMultipleFields = false) {
        const counts = isMultipleFields ? countByMultipleFields(data, fieldOrFields) : countByField(data, fieldOrFields);
        const ctx = document.getElementById(chartId).getContext("2d");
        if (charts[chartId]) charts[chartId].destroy();
        charts[chartId] = new Chart(ctx, {
          type: "pie",
          data: {
            labels: Object.keys(counts),
            datasets: [
              {
                data: Object.values(counts),
                backgroundColor: [
                  "#f39c12",
                  "#8e44ad",
                  "#27ae60",
                  "#e74c3c",
                  "#3498db",
                  "#f1c40f",
                  "#2ecc71",
                  "#34495e",
                  "#1abc9c",
                  "#2d3436",
                  "#fdcb6e",
                  "#00b894",
                  "#00cec9",
                  "#d63031",
                  "#636e72",
                ],
              },
            ],
          },
          options: {
            responsive: false,
            plugins: {
              legend: { position: "bottom" },
              title: { display: false },
            },
          },
        });
      }

      function renderTable(data) {
        const container = document.getElementById("table-container");
        if (!data.length) {
          container.innerHTML = "<p>No data found.</p>";
          return;
        }
        const table = document.createElement("table");
        // Header
        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");
        const dataColumns = Object.keys(data[0]);
        dataColumns.forEach((key) => {
          if (key !== "Project Summary") {
            const th = document.createElement("th");
            th.textContent = key;
            headerRow.appendChild(th);
          }
        });
        headerRow.appendChild(document.createElement("th")).textContent = "Details";
        thead.appendChild(headerRow);
        table.appendChild(thead);
        // Body
        const tbody = document.createElement("tbody");
        data.forEach((row) => {
          const tr = document.createElement("tr");
          dataColumns.forEach((k) => {
            if (k !== "Project Summary") {
              const td = document.createElement("td");
              if (k.trim().toLowerCase() === "thesis document" && row[k] && row[k].trim() !== "") {
                // Thesis document as hyperlink
                const link = document.createElement("a");
                link.href = row[k];
                link.target = "_blank";
                link.rel = "noopener noreferrer";
                link.textContent = "Download";
                td.appendChild(link);
              } else {
                td.textContent = row[k];
              }
              tr.appendChild(td);
            }
          });
          // Details cell: truncated summary + show more/less
          const tdDetails = document.createElement("td");
          const summary = row["Project Summary"] || "No summary available";
          const previewLen = 80;
          const isLong = summary.length > previewLen;
          const preview = isLong ? summary.slice(0, previewLen) + "..." : summary;

          const spanPreview = document.createElement("span");
          spanPreview.textContent = preview;
          tdDetails.appendChild(spanPreview);

          if (isLong) {
            const btn = document.createElement("button");
            btn.textContent = "Show more";
            btn.className = "show-details-btn";
            btn.style.marginLeft = "8px";
            const divFull = document.createElement("div");
            divFull.className = "summary-div";
            divFull.style.display = "none";
            divFull.textContent = summary;

            btn.onclick = function () {
              if (divFull.style.display === "block") {
                divFull.style.display = "none";
                spanPreview.style.display = "";
                btn.textContent = "Show more";
              } else {
                divFull.style.display = "block";
                spanPreview.style.display = "none";
                btn.textContent = "Show less";
              }
            };

            tdDetails.appendChild(btn);
            tdDetails.appendChild(divFull);
          }
          tr.appendChild(tdDetails);
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        container.innerHTML = "";
        container.appendChild(table);
      }

      function applyFilters() {
        const year = document.getElementById("year-select").value;
        const university = document.getElementById("university-select").value;
        const prof = document.getElementById("prof-select").value;
        const sponsorship = document.getElementById("sponsorship-select").value;

        filteredData = allData.filter(
          (row) =>
            (year === "" || row["Graduation Year"] === year) &&
            (university === "" || row[firstColumnName] === university) &&
            (sponsorship === "" || (row["Company Sponsorship"] || "").toLowerCase() === sponsorship.toLowerCase()) &&
            (prof === "" ||
              row["Supervisor 1"] === prof ||
              row["Supervisor 2"] === prof ||
              row["Company Mentor Name"] === prof)
        );
        renderPieChart(filteredData, "Graduation Year", "yearPie");
        renderPieChart(filteredData, firstColumnName, "universityPie");
        renderPieChart(filteredData, "Company Sponsorship", "sponsorshipPie");
        renderPieChart(filteredData, ["Supervisor 1", "Supervisor 2", "Company Mentor Name"], "profPie", true);
        renderTable(filteredData);
      }

      fetch(csvURL)
        .then((response) => {
          if (!response.ok) throw new Error("Network response was not ok");
          return response.text();
        })
        .then((csvText) => {
          Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
            complete: function (results) {
              allData = results.data;
              if (allData.length > 0) {
                // Use the first column as university
                firstColumnName = Object.keys(allData[0])[0];
              } else {
                firstColumnName = "University";
              }
              populateDropdown(allData, "Graduation Year", "year-select");
              populateDropdown(allData, firstColumnName, "university-select");
              // No need to populate sponsorship dropdown (it's static)
              populateDropdownMultipleFields(
                allData,
                ["Supervisor 1", "Supervisor 2", "Company Mentor Name"],
                "prof-select"
              );
              applyFilters();
            },
          });
        })
        .catch((err) => {
          document.getElementById("table-container").textContent = "Error loading CSV: " + err;
          console.error(err);
        });

      document.getElementById("year-select").addEventListener("change", applyFilters);
      document.getElementById("university-select").addEventListener("change", applyFilters);
      document.getElementById("prof-select").addEventListener("change", applyFilters);
      document.getElementById("sponsorship-select").addEventListener("change", applyFilters);
    });
  </script>
</body>
</html>